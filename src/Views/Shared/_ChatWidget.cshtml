<!-- Floating chat widget — powered by Phi-4-mini-instruct via Azure AI Foundry -->
<style>
    #chat-fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: #0d6efd;
        color: #fff;
        border: none;
        font-size: 1.4rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,.25);
        z-index: 1050;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #chat-fab:hover { background: #0b5ed7; }

    #chat-panel {
        position: fixed;
        bottom: 88px;
        right: 24px;
        width: 340px;
        height: 460px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,.18);
        display: flex;
        flex-direction: column;
        z-index: 1050;
        overflow: hidden;
    }
    #chat-panel.d-none { display: none !important; }

    #chat-header {
        background: #0d6efd;
        color: #fff;
        padding: 12px 16px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #chat-header small { font-weight: 400; opacity: .8; }

    #chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .chat-bubble {
        max-width: 82%;
        padding: 8px 12px;
        border-radius: 12px;
        font-size: .875rem;
        line-height: 1.4;
        word-break: break-word;
    }
    .chat-bubble.user {
        align-self: flex-end;
        background: #0d6efd;
        color: #fff;
        border-bottom-right-radius: 2px;
    }
    .chat-bubble.bot {
        align-self: flex-start;
        background: #fff;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 2px;
    }

    #chat-input-row {
        display: flex;
        padding: 10px;
        gap: 6px;
        border-top: 1px solid #dee2e6;
        background: #fff;
    }
    #chat-input { flex: 1; font-size: .875rem; }
    #chat-send { flex-shrink: 0; }
</style>

<!-- Floating action button -->
<button id="chat-fab" title="Ask our shopping assistant" aria-label="Open chat assistant">
    <i class="bi bi-chat-dots-fill"></i>
</button>

<!-- Chat panel -->
<div id="chat-panel" class="d-none">
    <div id="chat-header">
        <span><i class="bi bi-robot"></i> Store Assistant</span>
        <span>
            <small>Phi-4</small>
            <button class="btn btn-sm btn-close btn-close-white ms-2" id="chat-close" aria-label="Close chat"></button>
        </span>
    </div>

    <div id="chat-messages">
        <div class="chat-bubble bot">
            Hi! I'm your ZavaStorefront shopping assistant. Ask me anything about our products!
        </div>
    </div>

    <div id="chat-input-row">
        <input id="chat-input" type="text" class="form-control form-control-sm"
               placeholder="Ask about our products…" maxlength="1000" autocomplete="off" />
        <button id="chat-send" class="btn btn-primary btn-sm">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>

<script>
    (function () {
        const fab = document.getElementById('chat-fab');
        const panel = document.getElementById('chat-panel');
        const closeBtn = document.getElementById('chat-close');
        const messages = document.getElementById('chat-messages');
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send');

        fab.addEventListener('click', () => {
            panel.classList.toggle('d-none');
            if (!panel.classList.contains('d-none')) {
                input.focus();
                scrollToBottom();
            }
        });
        closeBtn.addEventListener('click', () => panel.classList.add('d-none'));

        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

        function scrollToBottom() {
            messages.scrollTop = messages.scrollHeight;
        }

        function appendBubble(text, role) {
            const div = document.createElement('div');
            div.className = `chat-bubble ${role}`;
            div.textContent = text;
            messages.appendChild(div);
            scrollToBottom();
            return div;
        }

        function setLoading(loading) {
            sendBtn.disabled = loading;
            input.disabled = loading;
            sendBtn.innerHTML = loading
                ? '<span class="spinner-border spinner-border-sm"></span>'
                : '<i class="bi bi-send-fill"></i>';
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            appendBubble(text, 'user');
            input.value = '';
            setLoading(true);

            try {
                const res = await fetch('/Chat/Send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                if (!res.ok) throw new Error('Request failed');

                const data = await res.json();
                appendBubble(data.reply, 'bot');
            } catch {
                appendBubble('Sorry, something went wrong. Please try again.', 'bot');
            } finally {
                setLoading(false);
                input.focus();
            }
        }
    })();
</script>
