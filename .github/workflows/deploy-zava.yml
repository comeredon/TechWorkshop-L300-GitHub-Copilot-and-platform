# Builds the Zava Storefront container image and deploys it to Azure App Service.
#
# Required GitHub Secrets:
#   AZURE_CLIENT_ID       – App Registration / User-Assigned Managed Identity client ID
#   AZURE_TENANT_ID       – Azure AD tenant ID
#   AZURE_SUBSCRIPTION_ID – Target Azure subscription ID
#
# The service principal need these Azure RBAC roles:
#   - AcrPush on the Container Registry
#   - Contributor (or "Website Contributor") on the App Service

name: Build and Deploy Zava to Azure App Service

on:
  # Run on every push to main -> build + deploy
  push:
    branches:
      - main
    paths:
      - "src/**"
      - ".github/workflows/deploy-zava.yml"

  # Run on PRs targeting main -> build only (no deploy), for validation
  pull_request:
    branches:
      - main
    paths:
      - "src/**"
      - ".github/workflows/deploy-zava.yml"

  # Allow manual runs from the Actions tab
  workflow_dispatch:

# ---------------------------------------------------------------------------
# Environment variables shared across all jobs
# ---------------------------------------------------------------------------
env:
  ACR_NAME: cr66tomjymtf5bc
  ACR_LOGIN_SERVER: cr66tomjymtf5bc.azurecr.io
  APP_SERVICE_NAME: app-66tomjymtf5bc
  RESOURCE_GROUP: GHC300trainingCRE
  IMAGE_NAME: zava-storefront

# OIDC token is required for azure/login; pull-requests write permission
# allows the workflow to post a status comment on the PR.
permissions:
  contents: read
  id-token: write
  pull-requests: write

# ---------------------------------------------------------------------------
# Jobs
# ---------------------------------------------------------------------------
jobs:
  # ── 1. Build & push the container image ───────────────────────────────────
  build:
    name: Build & Push Container Image
    runs-on: ubuntu-latest

    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Authenticate to Azure using OIDC (no long-lived credentials stored)
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Authenticate Docker CLI to ACR via the Azure CLI session
      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}

      # Compute a deterministic, human-readable image tag
      - name: Compute image tag
        id: image-tag
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "tag=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "Image tag: ${SHORT_SHA}"

      # Enable advanced Docker build features (layer caching, multi-platform, etc.)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build from src/ and push to ACR; cache layers in the Actions cache
      - name: Build and push container image
        uses: docker/build-push-action@v6
        with:
          context: ./src
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # On pull_request: post a comment with the built image reference so
      # reviewers can pull and test it locally.
      - name: Comment image tag on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.image-tag.outputs.tag }}';
            const image = '${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:' + tag;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **Container image built successfully**\n\n\`\`\`\n${image}\n\`\`\``
            });

  # ── 2. Deploy to Azure App Service (push to main / manual only) ────────────
  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: build

    # Skip deployment on pull_request events; only deploy when merging to main
    if: github.event_name != 'pull_request'

    environment:
      name: production
      url: https://app-66tomjymtf5bc.azurewebsites.net

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Update the App Service to pull the newly pushed image from ACR.
      # The App Service uses its System-Assigned Managed Identity (AcrPull)
      # to authenticate to ACR at runtime — no registry credentials needed here.
      - name: Deploy container image to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_SERVICE_NAME }}
          images: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}

      - name: Print App Service URL
        run: |
          echo "Deployment complete!"
          echo "Application URL: https://app-66tomjymtf5bc.azurewebsites.net"
